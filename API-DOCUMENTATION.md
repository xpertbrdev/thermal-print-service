# üñ®Ô∏è Thermal Printer Microservice - Documenta√ß√£o Completa da API\n\n## üìã Vis√£o Geral\n\nMicroservice profissional para impress√£o t√©rmica com suporte completo a comandos ESC/POS, sistema de sess√µes, filas de impress√£o e processamento avan√ßado de imagens.\n\n### ‚ú® Principais Funcionalidades\n\n- **Sistema de Sess√µes**: Controle total de jobs de impress√£o com IDs √∫nicos\n- **M√∫ltiplas Impressoras**: Suporte simult√¢neo a diferentes impressoras\n- **Comandos ESC/POS**: Elimina√ß√£o autom√°tica de margens f√≠sicas\n- **Processamento de Imagens**: Otimiza√ß√£o autom√°tica para impress√£o t√©rmica\n- **Filas Inteligentes**: Processamento sequencial por impressora\n- **Monitoramento**: Dashboard e m√©tricas em tempo real\n- **QR Codes Configur√°veis**: Tamanho e alinhamento personaliz√°veis\n- **Tabelas com Larguras Fixas**: Alinhamento perfeito de colunas\n\n---\n\n## üöÄ In√≠cio R√°pido\n\n### 1. Instala√ß√£o e Execu√ß√£o\n\n```bash\n# Clonar reposit√≥rio\ngit clone https://github.com/xpertbrdev/thermal-print-service.git\ncd thermal-print-service\n\n# Instalar depend√™ncias\nnpm install\n\n# Executar em desenvolvimento\nnpm run start:dev\n\n# Executar em produ√ß√£o\nnpm run build\nnpm run start:prod\n```\n\n### 2. Configura√ß√£o Inicial\n\n```bash\n# Configurar impressoras\ncurl -X POST http://localhost:3000/config \\\n  -H \"Content-Type: application/json\" \\\n  -d @examples/printer-config-updated.json\n\n# Verificar sa√∫de do servi√ßo\ncurl http://localhost:3000/print/health\n```\n\n### 3. Primeira Impress√£o\n\n```bash\n# Impress√£o simples\ncurl -X POST http://localhost:3000/print/session \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"printerId\": \"cozinha-1\",\n    \"content\": [\n      {\"type\": \"text\", \"value\": \"Ol√° Mundo!\", \"style\": {\"bold\": true}},\n      {\"type\": \"cut\"}\n    ]\n  }'\n```\n\n---\n\n## üìö Endpoints da API\n\n### üîß 1. CONFIGURA√á√ÉO\n\n#### POST /config\n**Configura m√∫ltiplas impressoras**\n\n```json\n{\n  \"printers\": [\n    {\n      \"id\": \"cozinha-1\",\n      \"name\": \"Impressora Cozinha 80mm\",\n      \"type\": \"epson\",\n      \"connectionType\": \"network\",\n      \"address\": \"192.168.1.100\",\n      \"charPerLine\": 48,\n      \"width\": 80,\n      \"printableWidth\": 80,\n      \"characterSet\": \"PC852_LATIN2\",\n      \"timeout\": 5000\n    }\n  ],\n  \"defaultSettings\": {\n    \"charPerLine\": 48,\n    \"width\": 80,\n    \"printableWidth\": 80,\n    \"characterSet\": \"PC852_LATIN2\",\n    \"timeout\": 5000\n  }\n}\n```\n\n**Comandos ESC/POS Autom√°ticos:**\n- `ESC l 0` (1B 6C 00) - Margem esquerda zero\n- `ESC Q 0` (1B 51 00) - Margem direita zero\n- Ou margens customizadas baseadas em `printableWidth`\n\n#### GET /config\n**Consulta todas as configura√ß√µes**\n\n#### GET /config/printers\n**Lista impressoras configuradas**\n\n#### GET /config/printers/:id\n**Detalhes de impressora espec√≠fica**\n\n---\n\n### üñ®Ô∏è 2. IMPRESS√ÉO COM SESS√ïES\n\n#### POST /print/session\n**Impress√£o com controle de sess√£o**\n\n```json\n{\n  \"printerId\": \"cozinha-1\",\n  \"sessionId\": \"sess_20241226_143022_abc12\",\n  \"priority\": \"normal\",\n  \"content\": [\n    {\n      \"type\": \"text\",\n      \"value\": \"PEDIDO #1234\",\n      \"style\": {\n        \"bold\": true,\n        \"align\": \"center\",\n        \"width\": 2,\n        \"height\": 2\n      }\n    },\n    {\n      \"type\": \"table\",\n      \"table\": {\n        \"headers\": [\"Item\", \"Qtd\", \"Valor\"],\n        \"rows\": [\n          {\"cells\": [\"Pizza Margherita\", \"1\", \"R$ 35,00\"]}\n        ],\n        \"columns\": [\n          {\"width\": 24, \"align\": \"left\"},\n          {\"width\": 4, \"align\": \"center\"},\n          {\"width\": 12, \"align\": \"right\"}\n        ],\n        \"separator\": \" | \",\n        \"borderChar\": \"-\"\n      }\n    },\n    {\n      \"type\": \"image\",\n      \"base64\": \"data:image/png;base64,iVBORw0KGgo...\"\n    },\n    {\n      \"type\": \"qr-code\",\n      \"value\": \"https://exemplo.com/pedido/1234\",\n      \"options\": {\n        \"size\": 6,\n        \"align\": \"center\"\n      }\n    },\n    {\n      \"type\": \"barcode\",\n      \"value\": \"1234567890\",\n      \"options\": {\n        \"type\": \"CODE128\",\n        \"width\": 2,\n        \"height\": 100,\n        \"align\": \"center\"\n      }\n    },\n    {\"type\": \"cut\"}\n  ]\n}\n```\n\n**Tipos de Conte√∫do Suportados:**\n\n| Tipo | Descri√ß√£o | Op√ß√µes |\n|------|-----------|--------|\n| `text` | Texto formatado | `bold`, `align`, `width`, `height` |\n| `image` | Imagem (URL/base64/local) | Otimiza√ß√£o autom√°tica |\n| `table` | Tabela com larguras fixas | `columns`, `separator`, `borderChar` |\n| `qr-code` | QR Code configur√°vel | `size`, `align` |\n| `barcode` | C√≥digo de barras | `type`, `width`, `height`, `align` |\n| `line` | Linha de caracteres | `character`, `length` |\n| `new-line` | Quebra de linha | - |\n| `cut` | Corte do papel | - |\n| `beep` | Som da impressora | - |\n| `cash-drawer` | Abertura da gaveta | - |\n\n#### POST /print\n**Impress√£o simples (sem sess√£o)**\n\n#### GET /print/status/:sessionId\n**Status da sess√£o**\n\n**Estados poss√≠veis:**\n- `queued` - Na fila aguardando\n- `printing` - Sendo processado\n- `completed` - Conclu√≠do com sucesso\n- `failed` - Falhou na execu√ß√£o\n- `cancelled` - Cancelado pelo usu√°rio\n\n#### DELETE /print/cancel/:sessionId\n**Cancelar sess√£o**\n\n---\n\n### üìä 3. MONITORAMENTO E FILAS\n\n#### GET /print/queue/:printerId\n**Fila de impress√£o da impressora**\n\n#### DELETE /print/queue/:printerId/clear\n**Limpar fila da impressora**\n\n#### GET /print/queue/stats\n**Estat√≠sticas das filas**\n\n#### GET /print/sessions\n**Listar sess√µes ativas**\n\n#### GET /monitoring/dashboard\n**Dashboard completo**\n\n```json\n{\n  \"timestamp\": \"2024-12-26T14:30:22.123Z\",\n  \"printers\": {\n    \"cozinha-1\": {\n      \"status\": \"online\",\n      \"queueSize\": 3,\n      \"processing\": \"sess_20241226_143022_abc12\",\n      \"lastJob\": \"2024-12-26T14:29:15.456Z\",\n      \"totalJobs\": 127,\n      \"successRate\": 98.4\n    }\n  },\n  \"system\": {\n    \"totalJobs\": 1250,\n    \"activeJobs\": 8,\n    \"completedJobs\": 1235,\n    \"failedJobs\": 7,\n    \"uptime\": \"2 days, 14 hours\"\n  },\n  \"alerts\": []\n}\n```\n\n#### GET /monitoring/metrics\n**M√©tricas detalhadas**\n\n#### GET /monitoring/alerts\n**Alertas do sistema**\n\n---\n\n### üß™ 4. TESTES ESC/POS\n\n#### GET /escpos-test/margin/:width\n**Testar comandos de margem**\n\n```bash\n# Margem zero para impressora 80mm\nGET /escpos-test/margin/80?printableWidth=80\n\n# √Årea customizada (80mm ‚Üí 72mm √∫teis)\nGET /escpos-test/margin/80?printableWidth=72\n```\n\n#### GET /escpos-test/compare-buffers\n**Comparar buffers com/sem ESC/POS**\n\n#### GET /escpos-test/validate/:printerId\n**Validar integra√ß√£o ESC/POS**\n\n#### POST /escpos-test/advanced-area\n**Teste comando ESC W (avan√ßado)**\n\n```json\n{\n  \"startXMm\": 4,\n  \"startYMm\": 0,\n  \"widthMm\": 72,\n  \"heightMm\": 200\n}\n```\n\n#### GET /escpos-test/info\n**Documenta√ß√£o ESC/POS**\n\n#### GET /escpos-test/scenarios\n**Cen√°rios de teste**\n\n---\n\n### üîß 5. UTILIT√ÅRIOS\n\n#### GET /print/health\n**Health check do servi√ßo**\n\n#### GET /print/test-connection\n**Teste de conex√£o com impressora**\n\n---\n\n## üéØ Casos de Uso Pr√°ticos\n\n### üçï Restaurante\n\n```json\n{\n  \"printerId\": \"cozinha-1\",\n  \"content\": [\n    {\"type\": \"text\", \"value\": \"PEDIDO #1234\", \"style\": {\"bold\": true, \"align\": \"center\"}},\n    {\"type\": \"text\", \"value\": \"Mesa: 15    Gar√ßom: Jo√£o\"},\n    {\n      \"type\": \"table\",\n      \"table\": {\n        \"headers\": [\"Item\", \"Qtd\", \"Obs\"],\n        \"rows\": [\n          {\"cells\": [\"Pizza Margherita\", \"1\", \"Sem cebola\"]}\n        ]\n      }\n    },\n    {\"type\": \"qr-code\", \"value\": \"https://restaurante.com/pedido/1234\"},\n    {\"type\": \"cut\"}\n  ]\n}\n```\n\n### üöö Delivery\n\n```json\n{\n  \"printerId\": \"delivery-1\",\n  \"content\": [\n    {\"type\": \"text\", \"value\": \"ETIQUETA DE ENTREGA\", \"style\": {\"bold\": true}},\n    {\"type\": \"text\", \"value\": \"Destinat√°rio: Maria Silva\"},\n    {\"type\": \"text\", \"value\": \"Endere√ßo: Rua das Flores, 123\"},\n    {\"type\": \"barcode\", \"value\": \"DEL5678\", \"options\": {\"type\": \"CODE128\"}},\n    {\"type\": \"cut\"}\n  ]\n}\n```\n\n### üè™ Varejo\n\n```json\n{\n  \"printerId\": \"balcao-1\",\n  \"content\": [\n    {\"type\": \"text\", \"value\": \"LOJA EXEMPLO LTDA\", \"style\": {\"align\": \"center\"}},\n    {\"type\": \"text\", \"value\": \"CUPOM FISCAL ELETR√îNICO\", \"style\": {\"bold\": true}},\n    {\n      \"type\": \"table\",\n      \"table\": {\n        \"headers\": [\"Produto\", \"Qtd\", \"Valor\"],\n        \"rows\": [\n          {\"cells\": [\"Produto A\", \"2\", \"R$ 10,00\"]}\n        ]\n      }\n    },\n    {\"type\": \"qr-code\", \"value\": \"https://nfce.fazenda.gov.br/qrcode?chNFe=...\"},\n    {\"type\": \"cut\"}\n  ]\n}\n```\n\n---\n\n## ‚öôÔ∏è Configura√ß√£o Avan√ßada\n\n### üìê √Årea de Impress√£o\n\n**Configura√ß√£o de Larguras:**\n\n```json\n{\n  \"width\": 80,           // Largura f√≠sica do papel (mm)\n  \"printableWidth\": 72,  // √Årea √∫til desejada (mm)\n  \"charPerLine\": 48      // Caracteres por linha\n}\n```\n\n**Comandos ESC/POS Gerados:**\n- Se `printableWidth < width`: Margens calculadas automaticamente\n- Se `printableWidth = width`: Margem zero (ESC l 0, ESC Q 0)\n- Se `printableWidth` n√£o especificado: Margem zero autom√°tica\n\n### üñºÔ∏è Processamento de Imagens\n\n**Pipeline Autom√°tico:**\n1. **Redimensionamento**: Para largura da impressora em pixels\n2. **Escala de Cinza**: Convers√£o otimizada\n3. **Normaliza√ß√£o**: Contraste autom√°tico\n4. **Brilho**: Ajuste +10% para visibilidade\n5. **Sharpening**: Defini√ß√£o aprimorada\n6. **Threshold**: P&B puros para impressoras\n\n**C√°lculo de Pixels:**\n```\nLargura em Pixels = (Largura em mm / 25.4) √ó DPI\nExemplo: 80mm = (80 / 25.4) √ó 203 = 640px\n```\n\n### üìä Tabelas com Larguras Fixas\n\n```json\n{\n  \"type\": \"table\",\n  \"table\": {\n    \"columns\": [\n      {\"width\": 20, \"align\": \"left\"},    // 20 caracteres, esquerda\n      {\"width\": 5, \"align\": \"center\"},   // 5 caracteres, centro\n      {\"width\": 10, \"align\": \"right\"}    // 10 caracteres, direita\n    ],\n    \"separator\": \" | \",                   // Separador entre colunas\n    \"borderChar\": \"-\"                     // Caractere da borda\n  }\n}\n```\n\n### üî≤ QR Codes Configur√°veis\n\n```json\n{\n  \"type\": \"qr-code\",\n  \"value\": \"https://exemplo.com\",\n  \"options\": {\n    \"size\": 6,        // Tamanho do m√≥dulo (1-16)\n    \"align\": \"center\" // Alinhamento (left, center, right)\n  }\n}\n```\n\n**Tamanhos Recomendados:**\n- `3-4`: Pequeno\n- `5-6`: M√©dio (recomendado)\n- `7-8`: Grande\n- `9+`: Muito Grande\n\n---\n\n## üîç Comandos ESC/POS Implementados\n\n### üìã Comandos Autom√°ticos\n\n| Comando | Hex | Descri√ß√£o | Quando Usado |\n|---------|-----|-----------|-------------|\n| `ESC l 0` | `1B 6C 00` | Margem esquerda = 0 | printableWidth = width |\n| `ESC Q 0` | `1B 51 00` | Margem direita = 0 | printableWidth = width |\n| `ESC l n` | `1B 6C n` | Margem esquerda customizada | printableWidth < width |\n| `ESC Q n` | `1B 51 n` | Margem direita customizada | printableWidth < width |\n| `ESC W` | `1B 57 ...` | √Årea de impress√£o avan√ßada | Comando opcional |\n\n### üßÆ C√°lculo de Unidades\n\n```\nUnidades ESC/POS = (mm / 25.4) √ó DPI / 8\nExemplo: 4mm = (4 / 25.4) √ó 203 / 8 ‚âà 10 units\n```\n\n### üß™ Valida√ß√£o\n\n```bash\n# Testar comandos\nGET /escpos-test/margin/80?printableWidth=72\n\n# Validar integra√ß√£o\nGET /escpos-test/validate/cozinha-1\n\n# Comparar buffers\nGET /escpos-test/compare-buffers\n```\n\n---\n\n## üìà Monitoramento e M√©tricas\n\n### üéØ KPIs Principais\n\n- **Taxa de Sucesso**: % de jobs conclu√≠dos com sucesso\n- **Tempo M√©dio**: Tempo m√©dio de processamento\n- **Fila M√©dia**: N√∫mero m√©dio de jobs na fila\n- **Uptime**: Tempo de atividade do servi√ßo\n- **Throughput**: Jobs processados por hora\n\n### üö® Alertas Autom√°ticos\n\n- **Impressora Offline**: Falha de conex√£o\n- **Alta Taxa de Erro**: > 5% de falhas\n- **Fila Longa**: > 10 jobs na fila\n- **Tempo de Resposta Alto**: > 30s por job\n- **Espa√ßo em Disco**: < 1GB dispon√≠vel\n\n### üìä Dashboard em Tempo Real\n\n```bash\n# Acessar dashboard\nGET /monitoring/dashboard\n\n# M√©tricas detalhadas\nGET /monitoring/metrics\n\n# Alertas ativos\nGET /monitoring/alerts\n```\n\n---\n\n## üõ†Ô∏è Troubleshooting\n\n### ‚ùå Problemas Comuns\n\n#### 1. Margem ainda presente ap√≥s comandos ESC/POS\n\n**Sintomas:**\n- Impress√£o n√£o chega at√© a borda\n- Espa√ßo em branco nas laterais\n\n**Solu√ß√µes:**\n```bash\n# Verificar comandos no buffer\nGET /escpos-test/validate/impressora-id\n\n# Testar margem zero\nGET /escpos-test/margin/80?printableWidth=80\n\n# Comparar com/sem ESC/POS\nGET /escpos-test/compare-buffers\n```\n\n#### 2. Imagens n√£o otimizadas\n\n**Sintomas:**\n- Imagens muito claras ou escuras\n- Qualidade ruim na impress√£o\n\n**Solu√ß√µes:**\n- Verificar se `width` e `printableWidth` est√£o corretos\n- Testar com imagens de diferentes contrastes\n- Verificar logs do ImageService\n\n#### 3. Tabelas desalinhadas\n\n**Sintomas:**\n- Colunas n√£o alinhadas\n- Texto cortado\n\n**Solu√ß√µes:**\n```json\n{\n  \"columns\": [\n    {\"width\": 20, \"align\": \"left\"},\n    {\"width\": 8, \"align\": \"right\"}\n  ]\n}\n```\n\n#### 4. Erro 413 (Request Too Large)\n\n**Sintomas:**\n- Falha ao enviar imagens base64 grandes\n\n**Solu√ß√µes:**\n- Limite atual: 50MB\n- Redimensionar imagem antes do envio\n- Usar URL ao inv√©s de base64\n\n### üîß Debug\n\n```bash\n# Health check\nGET /print/health\n\n# Teste de conex√£o\nGET /print/test-connection?printerId=cozinha-1\n\n# Status da sess√£o\nGET /print/status/sess_20241226_143022_abc12\n\n# Logs do sistema\ndocker logs thermal-printer-microservice\n```\n\n---\n\n## üì¶ Deployment\n\n### üê≥ Docker\n\n```dockerfile\nFROM node:18-alpine\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci --only=production\nCOPY dist ./dist\nEXPOSE 3000\nCMD [\"node\", \"dist/main\"]\n```\n\n```bash\n# Build\ndocker build -t thermal-printer-microservice .\n\n# Run\ndocker run -p 3000:3000 thermal-printer-microservice\n```\n\n### ‚ò∏Ô∏è Kubernetes\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: thermal-printer-microservice\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: thermal-printer\n  template:\n    metadata:\n      labels:\n        app: thermal-printer\n    spec:\n      containers:\n      - name: thermal-printer\n        image: thermal-printer-microservice:latest\n        ports:\n        - containerPort: 3000\n        env:\n        - name: NODE_ENV\n          value: \"production\"\n```\n\n### üîß Vari√°veis de Ambiente\n\n```bash\n# Porta do servi√ßo\nPORT=3000\n\n# Ambiente\nNODE_ENV=production\n\n# Configura√ß√µes de log\nLOG_LEVEL=info\n\n# Timeout padr√£o\nDEFAULT_TIMEOUT=5000\n\n# Diret√≥rio de configura√ß√£o\nCONFIG_DIR=/app/config\n```\n\n---\n\n## üîê Seguran√ßa\n\n### üõ°Ô∏è Boas Pr√°ticas\n\n- **Valida√ß√£o de Entrada**: Todos os payloads s√£o validados\n- **Rate Limiting**: Implementar limite de requisi√ß√µes\n- **HTTPS**: Usar TLS em produ√ß√£o\n- **Logs**: N√£o logar dados sens√≠veis\n- **Firewall**: Restringir acesso √†s impressoras\n\n### üîí Autentica√ß√£o (Opcional)\n\n```typescript\n// Implementar middleware de autentica√ß√£o\n@UseGuards(AuthGuard)\n@Controller('print')\nexport class PrinterController {\n  // ...\n}\n```\n\n---\n\n## üìä Performance\n\n### ‚ö° Otimiza√ß√µes\n\n- **Filas Ass√≠ncronas**: Processamento n√£o-bloqueante\n- **Cache de Configura√ß√£o**: Configura√ß√µes em mem√≥ria\n- **Pool de Conex√µes**: Reutiliza√ß√£o de conex√µes\n- **Compress√£o de Imagens**: Redu√ß√£o de tamanho\n- **Limpeza Autom√°tica**: Remo√ß√£o de arquivos tempor√°rios\n\n### üìà Benchmarks\n\n| Opera√ß√£o | Tempo M√©dio | Throughput |\n|----------|-------------|------------|\n| Impress√£o Simples | 50-200ms | 300 jobs/min |\n| Impress√£o com Imagem | 200-800ms | 100 jobs/min |\n| Processamento de Imagem | 100-500ms | 200 imgs/min |\n| QR Code | 30-100ms | 600 codes/min |\n| Tabela Complexa | 80-300ms | 250 tables/min |\n\n---\n\n## ü§ù Contribui√ß√£o\n\n### üîÑ Workflow\n\n1. Fork do reposit√≥rio\n2. Criar branch feature\n3. Implementar mudan√ßas\n4. Executar testes\n5. Criar Pull Request\n\n### üß™ Testes\n\n```bash\n# Testes unit√°rios\nnpm run test\n\n# Testes e2e\nnpm run test:e2e\n\n# Coverage\nnpm run test:cov\n```\n\n### üìù Padr√µes\n\n- **TypeScript**: Tipagem estrita\n- **ESLint**: Linting autom√°tico\n- **Prettier**: Formata√ß√£o de c√≥digo\n- **Conventional Commits**: Padr√£o de commits\n\n---\n\n## üìû Suporte\n\n### üÜò Canais de Suporte\n\n- **GitHub Issues**: Bugs e feature requests\n- **Documentation**: Documenta√ß√£o completa\n- **Examples**: Exemplos pr√°ticos\n- **Postman Collection**: Testes interativos\n\n### üìö Recursos Adicionais\n\n- [Reposit√≥rio GitHub](https://github.com/xpertbrdev/thermal-print-service)\n- [Collection Postman](./Thermal-Printer-Complete-API.postman_collection.json)\n- [Exemplos de Configura√ß√£o](./examples/)\n- [Guias de Teste](./examples/escpos-margin-test.json)\n\n---\n\n## üìÑ Licen√ßa\n\nMIT License - Veja [LICENSE](LICENSE) para detalhes.\n\n---\n\n## üéØ Roadmap\n\n### üöÄ Pr√≥ximas Funcionalidades\n\n- [ ] **Print to PDF**: Emulador de impressora para PDF\n- [ ] **WebSocket**: Notifica√ß√µes em tempo real\n- [ ] **Templates**: Sistema de templates reutiliz√°veis\n- [ ] **Multi-tenant**: Suporte a m√∫ltiplos clientes\n- [ ] **Analytics**: Dashboard avan√ßado de analytics\n- [ ] **API Gateway**: Integra√ß√£o com gateways\n- [ ] **Backup**: Sistema de backup autom√°tico\n- [ ] **Clustering**: Suporte a m√∫ltiplas inst√¢ncias\n\n### üîß Melhorias Planejadas\n\n- [ ] **Performance**: Otimiza√ß√µes adicionais\n- [ ] **Monitoring**: M√©tricas mais detalhadas\n- [ ] **Security**: Autentica√ß√£o e autoriza√ß√£o\n- [ ] **Documentation**: Documenta√ß√£o interativa\n- [ ] **Testing**: Cobertura de testes 100%\n- [ ] **CI/CD**: Pipeline completo\n\n---\n\n**üéâ Microservice de Impress√£o T√©rmica - Solu√ß√£o Completa e Profissional!**\n\n*Desenvolvido com ‚ù§Ô∏è para a comunidade de desenvolvedores*"
